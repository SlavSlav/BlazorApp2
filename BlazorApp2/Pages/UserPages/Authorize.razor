@page "/authorize"

@* <AuthorizeView>
    <Authorized>
        <div>
            <p>@User.Account.FirstName</p>
            <p>@User.Money</p>
            <button @onclick="AccountOut">Out</button>
        </div>

        @foreach (var order in User.GameOrders)
        {
            <GameComponents Game="order.Game"></GameComponents>
        }
    </Authorized>
    <NotAuthorized>
        <EditForm Model="Account" OnSubmit="OnSubmit">
            <div>
                <label>Email</label>
                <input @bind-value="Account.Email" />
            </div>
            <div>
                <label>Password</label>
                <input @bind-value="Account.Password" />
            </div>
            <button type="submit">Send</button>

            </EditForm>
    </NotAuthorized>
   
</AuthorizeView>
 *@
   @*  @if (User != null)
    {
        <div>
            <p>@User.Account.FirstName</p>
            <p>@User.Money</p>
            <button @onclick="AccountOut">Out</button>
        </div>
        @foreach (var order in User.GameOrders)
        {
            <GameComponents Game="order.Game"></GameComponents>
        }
    }   
    else
    {
        <EditForm Model="Account" OnSubmit="OnSubmit">
            <div>
                <label>Email</label>
                <input @bind-value="Account.Email" />
            </div>
            <div>
                <label>Password</label>
                <input @bind-value="Account.Password" />
            </div>
            <button type="submit">Send</button>

    </EditForm>        
    } *@

    <GameComponents Game ="new GameModel()
    {
        Id = Guid.NewGuid()

    }"></GameComponents>



@code {
    public AccountModel Account { get; set; }
    public static UserModel? User { get; set; }

    public List<GameModel> Games { get; set; }


    public Authorize ()
    {
        Games = new List<GameModel>();
        Account = new AccountModel()
        {
                Email = "bisnesbrend@gmail.com",
                FirstName = "Vladislav",
                LastName = "Cherkis",
                Phone = "0977258244",
                Password = "123321"
        };
    }

    protected override async Task OnInitializedAsync()
    {
        using(EntityDataBase db = new EntityDataBase())
        {   
            if (db.Games.Count() == 0)
            {
                // var users = new List<UserModel>()
                // {
                //     new UserModel()
                //     {                        
                //         Account = new AccountModel()
                //         {
                //             Id =    Guid.NewGuid(),
                //             Email = "bisnesbrend@gmail.com",
                //             FirstName = "Vladislav",
                //             LastName = "Cherkis",
                //             Phone = "0977258244",
                //             Password = "123321"
                //         }, 
                //         Settings = new SettingsModel()
                //         {
                //             Dark=false,
                //         },
                //         GameOrders = new List<OrderModel>()
                //     },
                //     new UserModel()
                //     {                        
                //         Account= new AccountModel()
                //         {
                //             Id = Guid.NewGuid(),
                //             Email = "bisnes@gmail.com",
                //             FirstName = "Vlad",
                //             LastName = "Cherk",
                //             Phone = "0977258244",
                //             Password = "123321"
                //         },
                //         Settings = new SettingsModel()
                //         {
                //             Dark=false,
                //         },
                //         GameOrders = new List<OrderModel>()
                //     }
                // };
                // db.Users.AddRange(users);
                // db.SaveChanges();
                var companies = new List<CompanyModel>()
                {
                    new CompanyModel()
                    {
                        Title = "Larian Studios",
                        Games = new List<GameModel>()
                        {
                            new GameModel()
                            {
                                Id= Guid.NewGuid(),
                                Title = "Baldur's Gate 3",
                                Image = "https://image.api.playstation.com/vulcan/ap/rnd/202308/3103/70c864f97f52f9b632d1f519a0364a5d0e2b98dc5501f058.jpg?w=620&thumb=false",
                                Price = 1000,
                                GamesOrders = new List<OrderModel>()
                            },

                            new GameModel()
                            {
                                Id= Guid.NewGuid(),
                                Title = "Divinity: Original Sin 2",
                                Image = "https://cdn.cloudflare.steamstatic.com/steam/apps/435150/capsule_616x353.jpg?t=1668591196",
                                Price = 3476,
                                GamesOrders = new List<OrderModel>()
                            },

                            new GameModel()
                            {
                                Id= Guid.NewGuid(),
                                Title = "Divinity: Original Sin - Enhanced Edition",
                                Image = "https://cdn.cloudflare.steamstatic.com/steam/apps/373420/header.jpg?t=1665155407",
                                Price = 799,
                                GamesOrders = new List<OrderModel>()
                            },
                        }
                    },
                    new CompanyModel()
                    {
                        Title = "Blizzard Entertainment",
                        Games = new List<GameModel>()
                        {
                            new GameModel()
                            {
                                Id= Guid.NewGuid(),
                                Title = "StarCraft II",
                                Image = "https://bnetcmsus-a.akamaihd.net/cms/blog_header/2g/2G4VZH5TIWJF1602720144046.jpg",
                                Price = 0,
                                GamesOrders = new List<OrderModel>()
                            }
                        }
                    }
                };

               
                db.Company.AddRange(companies);
                db.SaveChanges();
            }

            Games = db.Games.ToList();
        }
    }

    public void OnSubmit(EditContext editContext)
    {
        var valid = editContext.Validate();
        using (var database = new EntityDataBase())
        {
            var account = database.Accounts.FirstOrDefault(a => a.Email == Account.Email &&
                                                            a.Password == Account.Password);
            if (account != null)
            {
                User = account.User;
            }
        };
    }

    public void AccountOut()
    {
        User = null;
        Account = new AccountModel();
    }

    protected override void OnAfterRender(bool firstRender)
    {
        
    }
}
